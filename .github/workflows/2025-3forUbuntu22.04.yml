name: "Build & Release OpenVINO 2025.3.0 .deb (Ubuntu 22.04)"

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write   # needed to upload assets to releases
  actions: read

jobs:
  build-openvino:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          ccache \
          patchelf \
          lsb-release \
          wget \
          unzip \
          pkg-config \
          libgtk-3-dev \
          libdrm-dev \
          libtbb-dev \
          libpugixml-dev

    - name: Clone OpenVINO 2025.3.0
      run: |
        git clone https://github.com/openvinotoolkit/openvino.git
        cd openvino
        git checkout tags/2025.3.0 -b build-2025.3.0
        git submodule update --init --recursive

    - name: Configure (no Python)
      run: |
        cd openvino
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_PYTHON=OFF \
          -DENABLE_TESTS=OFF \
          -DENABLE_SAMPLES=ON \
          -DCMAKE_INSTALL_PREFIX=/opt/openvino-runtime

    - name: Build OpenVINO
      run: |
        cd openvino/build
        make -j$(nproc)

    - name: Install into staging directory
      run: |
        cd openvino/build
        DESTDIR=$GITHUB_WORKSPACE/debroot make install


    - name: Create DEBIAN control files
      shell: bash
      run: |
        mkdir -p debroot/DEBIAN
        cat > debroot/DEBIAN/control <<'EOF'
        Package: openvino-runtime
        Version: 2025.3.0
        Section: libs
        Priority: optional
        Architecture: amd64
        Maintainer: Stefan Eickeler <eickeler@gnu.org>
        Description: OpenVINO Runtime (C++ only), built from official sources (2025.3.0).
         No Python bindings. Ubuntu 22.04 build.
        EOF
        
    - name: Build .deb package
      run: |
        dpkg-deb --build debroot openvino-runtime_2025.3.0_22.04__amd64.deb

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: openvino-runtime_2025.3.0_22.04__amd64.deb
        # If run via workflow_dispatch, publish to "v2025.3.0"
        tag_name: ${{ github.ref_name == 'main' && 'v2025.3.0' || github.ref_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
